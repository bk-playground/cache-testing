# image: "${BUILDKITE_HOSTED_REGISTRY_URL}/golang-cli-example_base:latest"

# agents:
#   queue: "hosted"

# cache:
#   name: "golang-cache"
#   paths:
#     - "/gocache"
#     - "/gomodcache"
#   size: "100g"

# env:
#   GOCACHE: "/gocache"
#   GOMODCACHE: "/gomodcache"

# steps:
#   - if_changed: ".buildkite/Dockerfile.build"
#     key: base_image
#     label: ":docker: Create base image"
#     # use public base image to avoid recursion or broken base images blocking rebuilds
#     image: "buildkite/hosted-agent-base-images:ubuntu-jammy"
#     command: |
#       docker buildx build \
#         --no-cache \
#         --file .buildkite/Dockerfile.build \
#         --platform linux/amd64,linux/arm64 \
#         --tag "${BUILDKITE_HOSTED_REGISTRY_URL}/golang-cli-example_base:latest" \
#         --progress plain \
#         --push .

#   - group: ":mag: QA"
#     key: quality_checks
#     depends_on: [base_image]
#     steps:
#       - key: lint
#         label: ":golangci-lint: lint"
#         command: golangci-lint run --verbose --timeout 3m

#       - key: test
#         label: ":go: test"
#         artifact_paths:
#           - cover-tree.svg
#           - coverage.out
#         commands:
#           - go test -coverprofile coverage.out -coverpkg=./... ./...
#           - go run github.com/nikolaydubina/go-cover-treemap -coverprofile coverage.out > cover-tree.svg
#           - echo '<details><summary>Coverage tree map</summary><img src="artifact://cover-tree.svg" alt="Test coverage tree map" width="70%"></details>' | buildkite-agent annotate --style "info"

steps:
  - label: ":go: lint"
    env:
      GOCACHE: "/var/lib/buildkite-agent/.go-build"
      GOMODCACHE: "/var/lib/buildkite-agent/go/pkg/mod"
      USER_ID: "2000"
      GROUP_ID: "2000"
    plugins:
      - aws-assume-role-with-web-identity#v1.1.0:
          role-arn: ${CACHE_ROLE}
      - docker-compose#v5.6.0:
          run: app
          config: ".buildkite/docker-compose.yml"
          builder:
            name: container
            driver: docker-container
            create: true
            use: true
          retry:
            automatic:
              - limit: 2
                exit_status: 17
          propagate-environment: true
          # cache-to:
          #   - app:type=local,src=~/.buildx
          # cache-from:
          #   - app:type=local,src=~/.buildx
      - .buildkite/plugins/zstash:
          # ids: buildx
          ids: buildx,golang_build,golang_pkg
    commands:
      - golangci-lint run --verbose --timeout 3m
  # - label: ":go: test"
  #   plugins:
  #     - aws-assume-role-with-web-identity#v1.1.0:
  #         role-arn: ${CACHE_ROLE}
  #     - docker-compose#v5.6.0:
  #         run: app
  #         config: ".buildkite/docker-compose.yml"
  #         retry:
  #           automatic:
  #             - limit: 2
  #               exit_status: 17
  #         propagate-environment: true
  #         propagate-aws-auth-tokens: true
  #         mount-buildkite-agent: true
  #   commands:
  #     - .buildkite/scripts/gotest.sh
  # - label: ":bun: build"
  #   plugins:
  #     - aws-assume-role-with-web-identity#v1.1.0:
  #         role-arn: ${CACHE_ROLE}
  #     - docker-compose#v5.6.0:
  #         run: app
  #         config: ".buildkite/docker-compose.yml"
  #         retry:
  #           automatic:
  #             - limit: 2
  #               exit_status: 17
  #         propagate-environment: true
  #         propagate-aws-auth-tokens: true
  #         mount-buildkite-agent: true
  #   commands:
  #     - buildkite-agent cache restore --ids node --bucket-url $CACHE_BUCKET_URL
  #     - bun install
  #     - bun run build
  #     - buildkite-agent cache save --ids node --bucket-url $CACHE_BUCKET_URL